<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Ventas Inter (Bootstrap)</title>
    <!-- Carga de Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-color: #f8f9fa; /* bg-gray-50 */
            font-family: 'Inter', sans-serif;
        }

        /* Estilos personalizados de color para los estatus (simulando la paleta Inter) */
        .status-CONECTADO { background-color: #198754; color: white; } /* Bootstrap Success (Verde) */
        .status-PENDIENTE { background-color: #ffc107; color: #343a40; } /* Bootstrap Warning (Amarillo Inter) */
        .status-EMITIDA { background-color: #0d6efd; color: white; } /* Bootstrap Primary (Azul) */
        .status-CANCELADA { background-color: #6c757d; color: white; } /* Bootstrap Secondary (Gris) */
        
        .status-display {
            padding: .25em .4em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: .25rem;
            min-width: 80px;
            display: inline-block;
        }

        .inter-header {
            border-bottom: 5px solid #ffc107; /* Amarillo de Inter */
        }
    </style>
</head>
<body>

    <div class="container my-5 max-w-6xl">
        <!-- Logo/Título al estilo Inter -->
        <header class="text-center mb-5 p-4 bg-white rounded-3 shadow-sm inter-header">
            <h1 class="display-5 fw-bold text-dark">
                INTER <span class="text-warning">VENTAS</span>
            </h1>
            <p class="text-muted mt-1">Herramienta de Registro Operacional</p>
        </header>

        <!-- Contenedor del Mensaje (Usando Bootstrap Alerts) -->
        <div id="message-box" class="alert d-none text-center font-weight-bold transition-all shadow-sm" role="alert"></div>

        <!-- Formulario - En un card de Bootstrap -->
        <div class="card shadow-lg mb-5 border-0 rounded-3">
            <div class="card-body p-4 p-md-5">
                <h2 class="card-title h4 mb-4 text-dark fw-bold">Formulario de Registro</h2>

                <!-- No-Validated Form para usar validación manual en JS -->
                <form id="venta-form" novalidate> 
                    <div class="row g-4">
                        
                        <!-- Nombre del Abonado -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <label for="nombre" class="form-label text-muted">Nombre del Abonado</label>
                            <input type="text" id="nombre" class="form-control" placeholder="Ej: Juan Pérez" required>
                            <div class="invalid-feedback" id="nombre-feedback">
                                Solo se permiten letras y espacios.
                            </div>
                        </div>

                        <!-- Número de Abonado -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <label for="numero" class="form-label text-muted">Número de Abonado</label>
                            <input type="text" id="numero" class="form-control" placeholder="Ej: 1001" required>
                            <div class="invalid-feedback" id="numero-feedback">
                                Solo se permiten caracteres numéricos.
                            </div>
                        </div>

                        <!-- PERMISOR -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <label for="permisor" class="form-label text-muted">PERMISOR</label>
                            <select id="permisor" class="form-select" required>
                                <option value="">Seleccione un Permisor</option>
                                <option value="1">1 Barquisimeto</option>
                                <option value="2">2 Merida</option>
                                <option value="3">3 Maracay</option>
                                <option value="4">4 Acarigua</option>
                                <option value="5">5 San Felipe</option>
                                <option value="6">6 Maracaibo</option>
                                <option value="7">7 Valencia</option>
                                <option value="8">8 Carora</option>
                                <option value="9">9 Valera</option>
                                <option value="10">10 Barinas</option>
                                <option value="11">11 Puerto Ordaz</option>
                                <option value="12">12 Montalban</option>
                                <option value="13">13 Guanare</option>
                                <option value="14">14 San Juan de los Morros</option>
                                <option value="15">15 Anaco</option>
                                <option value="16">16 El Tigre</option>
                                <option value="17">17 Cabimas</option>
                                <option value="18">18 Ciudad Bolivar</option>
                                <option value="19">19 Maturin</option>
                                <option value="20">20 San Fernando de Apure</option>
                                <option value="21">21 Yaritagua</option>
                                <option value="22">22 Charallave</option>
                                <option value="23">23 Los Teques</option>
                                <option value="24">24 Barcelona</option>
                                <option value="25">25 Caracas</option>
                                <option value="26">26 Tinaco</option>
                                <option value="28">28 Guarenas</option>
                                <option value="30">30 La Guaira</option>
                                <option value="31">31 San Cristobal</option>
                                <option value="35">35 San Carlos</option>
                                <option value="36">36 Tinaquillo</option>
                                <option value="37">37 Coro</option>
                                <option value="40">40 Punto Fijo</option>
                                <option value="41">41 Moron</option>
                                <option value="42">42 El Vigia</option>
                                <option value="44">44 Cumana</option>
                                <option value="54">54 Chichiriviche</option>
                                <option value="55">55 Margarita</option>
                                <option value="58">58 Puerto Ayacucho</option>
                                <option value="59">59 Tucupita</option>
                                <option value="60">60 Puerto Cabello</option>
                                <option value="61">61 Churuguara</option>
                                <option value="62">62 Cumanacoa</option>
                                <option value="63">63 Chivacoa</option>
                                <option value="66">66 Puerto Piritu</option>
                                <option value="67">67 Temblador</option>
                            </select>
                            <div class="invalid-feedback">Seleccione un permisor.</div>
                        </div>

                        <!-- Fecha de Venta -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <label for="fecha" class="form-label text-muted">Fecha de Venta</label>
                            <input type="date" id="fecha" class="form-control" required>
                            <div class="invalid-feedback" id="fecha-feedback">
                                La fecha no puede ser futura.
                            </div>
                        </div>

                        <!-- Tipo de Servicio -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <label for="tipo-servicio" class="form-label text-muted">Tipo de Servicio</label>
                            <select id="tipo-servicio" class="form-select">
                                <option value="VENTA NUEVA">VENTA NUEVA</option>
                                <option value="RECONEXIÓN">RECONEXIÓN</option>
                                <option value="MEJORA">MEJORA</option>
                            </select>
                        </div>

                        <!-- SERVICIOS -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <label for="servicios" class="form-label text-muted">SERVICIOS</label>
                            <select id="servicios" class="form-select" required>
                                <option value="">Seleccione un servicio</option>
                                <option value="FTTH COMBO 1 300 MEGAS">FTTH COMBO 1 300 MEGAS</option>
                                <option value="FTTH COMBO 2 600 MEGAS">FTTH COMBO 2 600 MEGAS</option>
                                <option value="FTTH COMBO 4 1GIGA">FTTH COMBO 4 1GIGA</option>
                                <option value="PROMOCION OCCIDENTE 1 GIGA">PROMOCION OCCIDENTE 1 GIGA</option>
                                <option value="PROMOCIÓN BAJA PENETRACION 50 MEGAS">PROMOCIÓN BAJA PENETRACION 50 MEGAS</option>
                                <option value="TOMA ADICIONAL DE TV">TOMA ADICIONAL DE TV</option>
                            </select>
                            <div class="invalid-feedback">Seleccione un servicio.</div>
                        </div>
                        
                        <!-- Tomas Adicionales (Condicional) -->
                        <div id="tomas-adicionales-container" class="col-12 col-md-6 col-lg-4 d-none">
                            <label for="tomas-adicionales" class="form-label text-muted">Cantidad de Tomas Adicionales</label>
                            <select id="tomas-adicionales" class="form-select">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                            <div class="invalid-feedback">Seleccione la cantidad.</div>
                        </div>
                        
                        <!-- Estatus -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <label for="estatus" class="form-label text-muted">Estatus</label>
                            <select id="estatus" class="form-select">
                                <option value="PENDIENTE">PENDIENTE</option>
                                <option value="EMITIDA">EMITIDA</option>
                                <option value="CONECTADO">CONECTADO</option>
                                <option value="CANCELADA">CANCELADA</option>
                            </select>
                        </div>

                    </div>

                    <!-- Botón de Agregar - Estilo Amarillo/Ámbar de Inter -->
                    <button type="submit" class="btn btn-warning text-dark fw-bold rounded-pill px-5 py-2 mt-4 shadow-sm">
                        Registrar Nueva Venta
                    </button>
                </form>
            </div>
        </div>

        <!-- Sección de Tabla de Ventas -->
        <h2 class="h4 fw-bold mb-3 text-dark">Ventas Agregadas</h2>
        
        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4 p-3 bg-white rounded-3 shadow-sm border border-light">
            <p class="text-muted mb-3 mb-sm-0 small">Tabla temporal de las ventas registradas en esta sesión.</p>
            <!-- Botón de Exportar -->
            <button id="exportar-csv" class="btn btn-primary btn-sm px-4 py-2 shadow-sm" disabled>
                Exportar a CSV (Excel)
            </button>
        </div>

        <!-- Contenedor de la tabla -->
        <div class="table-responsive bg-white rounded-3 shadow-lg">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th scope="col" class="px-3 py-3">Nombre</th>
                        <th scope="col" class="px-3 py-3">N° Abonado</th>
                        <th scope="col" class="px-3 py-3">PERMISOR</th>
                        <th scope="col" class="px-3 py-3">Fecha</th>
                        <th scope="col" class="px-3 py-3">Tipo Servicio</th>
                        <th scope="col" class="px-3 py-3">SERVICIOS</th>
                        <th scope="col" class="px-3 py-3 text-center">Estatus</th>
                        <!-- NUEVA COLUMNA DE ACCIONES -->
                        <th scope="col" class="px-3 py-3 text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tabla-body">
                    <!-- Fila de ejemplo de "vacío" -->
                    <tr id="fila-vacia">
                        <!-- COLSPAN AHORA ES 8 -->
                        <td colspan="8" class="px-3 py-4 text-center text-muted">Aún no hay ventas registradas.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Carga de Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Mapa para convertir el ID del Permisor (el número) al nombre completo para visualización
        const permisoresMap = {
            '1': 'Barquisimeto', '2': 'Merida', '3': 'Maracay', '4': 'Acarigua', '5': 'San Felipe', '6': 'Maracaibo', '7': 'Valencia', '8': 'Carora', '9': 'Valera', '10': 'Barinas', '11': 'Puerto Ordaz', '12': 'Montalban', '13': 'Guanare', '14': 'San Juan de los Morros', '15': 'Anaco', '16': 'El Tigre', '17': 'Cabimas', '18': 'Ciudad Bolivar', '19': 'Maturin', '20': 'San Fernando de Apure', '21': 'Yaritagua', '22': 'Charallave', '23': 'Los Teques', '24': 'Barcelona', '25': 'Caracas', '26': 'Tinaco', '28': 'Guarenas', '30': 'La Guaira', '31': 'San Cristobal', '35': 'San Carlos', '36': 'Tinaquillo', '37': 'Coro', '40': 'Punto Fijo', '41': 'Moron', '42': 'El Vigia', '44': 'Cumana', '54': 'Chichiriviche', '55': 'Margarita', '58': 'Puerto Ayacucho', '59': 'Tucupita', '60': 'Puerto Cabello', '61': 'Churuguara', '62': 'Cumanacoa', '63': 'Chivacoa', '66': 'Puerto Piritu', '67': 'Temblador'
        };

        // Array para almacenar las ventas en memoria
        let ventas = [];

        // Referencias del DOM
        const form = document.getElementById('venta-form');
        const tablaBody = document.getElementById('tabla-body');
        const filaVacia = document.getElementById('fila-vacia');
        const btnExportar = document.getElementById('exportar-csv');
        const messageBox = document.getElementById('message-box');
        
        // Input references
        const nombreInput = document.getElementById('nombre');
        const numeroInput = document.getElementById('numero');
        const fechaInput = document.getElementById('fecha');
        const nombreFeedback = document.getElementById('nombre-feedback');
        const numeroFeedback = document.getElementById('numero-feedback');
        const fechaFeedback = document.getElementById('fecha-feedback');

        const serviciosSelect = document.getElementById('servicios');
        const tomasContainer = document.getElementById('tomas-adicionales-container');
        const tomasSelect = document.getElementById('tomas-adicionales');
        const permisorSelect = document.getElementById('permisor');


        // Función para mostrar mensajes (usando clases de alerta de Bootstrap)
        function showMessage(message, type = 'success') { // type can be 'success' or 'error'
            messageBox.textContent = message;
            messageBox.classList.remove('d-none', 'alert-success', 'alert-danger');
            
            if (type === 'error') {
                messageBox.classList.add('alert-danger');
            } else {
                messageBox.classList.add('alert-success');
            }

            // Ocultar mensaje después de 3 segundos
            setTimeout(() => {
                messageBox.classList.add('d-none');
            }, 3000);
        }
        
        // Manejador para mostrar/ocultar el campo de tomas adicionales
        serviciosSelect.addEventListener('change', () => {
            if (serviciosSelect.value === 'TOMA ADICIONAL DE TV') {
                tomasContainer.classList.remove('d-none');
                tomasSelect.required = true;
            } else {
                tomasContainer.classList.add('d-none');
                tomasSelect.required = false;
                // También limpiamos la validación si se oculta
                tomasSelect.classList.remove('is-invalid', 'is-valid');
            }
        });


        // Manejador del envío del formulario
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            e.stopPropagation();

            // 1. Resetear el estado de validación
            form.classList.remove('was-validated');
            document.querySelectorAll('.form-control, .form-select').forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });
            
            const nombre = nombreInput.value.trim();
            const numero = numeroInput.value.trim();
            const fechaString = fechaInput.value;
            
            let isValid = true;
            
            // --- VALIDACIONES DETALLADAS ---

            // 1. Nombre del Abonado (Solo letras, espacios y caracteres especiales de nombres como acentos, guiones)
            if (nombre === '') {
                nombreInput.classList.add('is-invalid');
                nombreFeedback.textContent = 'Este campo es obligatorio.';
                isValid = false;
            } else if (/[^a-zA-Z\sÁÉÍÓÚáéíóúñÑ-]/.test(nombre)) {
                nombreInput.classList.add('is-invalid');
                nombreFeedback.textContent = 'Solo se permiten letras, espacios y guiones.';
                isValid = false;
            } else {
                nombreInput.classList.add('is-valid');
            }
            
            // 2. Número de Abonado (Solo números)
            if (numero === '') {
                numeroInput.classList.add('is-invalid');
                numeroFeedback.textContent = 'Este campo es obligatorio.';
                isValid = false;
            } else if (!/^\d+$/.test(numero)) {
                numeroInput.classList.add('is-invalid');
                numeroFeedback.textContent = 'Solo se permiten caracteres numéricos.';
                isValid = false;
            } else {
                numeroInput.classList.add('is-valid');
            }

            // 3. Fecha de Venta (No mayor a hoy)
            if (fechaString) {
                const fechaSeleccionada = new Date(fechaString + 'T00:00:00'); 
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0); 

                if (fechaSeleccionada > hoy) {
                    fechaInput.classList.add('is-invalid');
                    fechaFeedback.textContent = 'La fecha de venta no puede ser futura.';
                    isValid = false;
                } else {
                    fechaInput.classList.add('is-valid');
                }
            } else {
                 fechaInput.classList.add('is-invalid');
                 fechaFeedback.textContent = 'Este campo es obligatorio.';
                 isValid = false;
            }

            // 4. Otros campos obligatorios (Permisor, Servicios)
            if (!permisorSelect.value) {
                permisorSelect.classList.add('is-invalid');
                isValid = false;
            } else {
                permisorSelect.classList.add('is-valid');
            }

            if (!serviciosSelect.value) {
                serviciosSelect.classList.add('is-invalid');
                isValid = false;
            } else {
                serviciosSelect.classList.add('is-valid');
            }

            // 5. Validación de Tomas Adicionales (Condicional)
            if (serviciosSelect.value === 'TOMA ADICIONAL DE TV') {
                if (!tomasSelect.value) {
                    tomasSelect.classList.add('is-invalid');
                    isValid = false;
                } else {
                    tomasSelect.classList.add('is-valid');
                }
            }


            if (!isValid) {
                // Muestra el feedback de Bootstrap si falla
                form.classList.add('was-validated'); 
                showMessage('Por favor, corrige los errores en el formulario antes de registrar.', 'error');
                return;
            }


            // --- PROCESAMIENTO DE DATOS (Si es Válido) ---
            
            let serviciosValue = serviciosSelect.value;
            
            // Lógica para TOMA ADICIONAL DE TV
            if (serviciosValue === 'TOMA ADICIONAL DE TV') {
                const numTomas = tomasSelect.value;
                serviciosValue = `TOMA ADICIONAL DE TV (${numTomas} Tomas)`;
            }
            
            const venta = {
                nombre: nombre,
                numero: numero,
                permisorId: permisorSelect.value, 
                fecha: fechaString,
                tipoServicio: document.getElementById('tipo-servicio').value,
                servicios: serviciosValue, 
                estatus: document.getElementById('estatus').value,
            };

            ventas.push(venta);
            actualizarTabla();

            // Limpiar formulario y ocultar tomas adicionales
            form.reset();
            tomasContainer.classList.add('d-none');
            // Resetear la validación visual
            document.querySelectorAll('.form-control, .form-select').forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });

            // Establecer fecha de hoy por defecto de nuevo
            setInitialDate(); 
            
            showMessage('Venta agregada a la lista exitosamente.', 'success');
        });

        // Función para eliminar una venta por su índice
        window.eliminarVenta = function(index) {
            // Asegurarse de que el índice sea válido
            if (index >= 0 && index < ventas.length) {
                // Eliminar 1 elemento del array en la posición 'index'
                ventas.splice(index, 1);
                actualizarTabla();
                showMessage('Venta eliminada correctamente.', 'error');
            }
        }


        // Función para actualizar la tabla en la página
        function actualizarTabla() {
            tablaBody.innerHTML = '';

            if (ventas.length === 0) {
                const emptyRow = filaVacia.cloneNode(true);
                emptyRow.id = '';
                // Asegurarse de que el colspan sea 8 para la fila vacía
                emptyRow.querySelector('td').setAttribute('colspan', '8');
                tablaBody.appendChild(emptyRow);
                btnExportar.disabled = true;
            } else {
                btnExportar.disabled = false;

                ventas.forEach((venta, index) => {
                    const tr = document.createElement('tr');
                    
                    const estatusClass = venta.estatus.toUpperCase().replace('Í', 'I');
                    
                    const cityName = permisoresMap[venta.permisorId] || 'Desconocido';
                    const permisorDisplay = `${venta.permisorId} ${cityName}`;

                    tr.innerHTML = `
                        <td class="px-3 py-3 text-break">${venta.nombre}</td>
                        <td class="px-3 py-3">${venta.numero}</td>
                        <td class="px-3 py-3">${permisorDisplay}</td>
                        <td class="px-3 py-3">${venta.fecha}</td>
                        <td class="px-3 py-3">${venta.tipoServicio}</td>
                        <td class="px-3 py-3">${venta.servicios}</td>
                        <td class="px-3 py-3 text-center">
                            <span class="status-display status-${estatusClass}">
                                ${venta.estatus}
                            </span>
                        </td>
                        <td class="px-3 py-3 text-center">
                            <button class="btn btn-danger btn-sm" onclick="eliminarVenta(${index})">Eliminar</button>
                        </td>
                    `;
                    tablaBody.appendChild(tr);
                });
            }
        }

        // Función auxiliar para establecer la fecha actual
        function setInitialDate() {
            if (fechaInput) {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                fechaInput.value = `${year}-${month}-${day}`;
            }
        }

        // Manejador del botón de exportar
        btnExportar.addEventListener('click', () => {
            if (ventas.length === 0) {
                showMessage('No hay datos para exportar.', 'error');
                return;
            }

            exportarACSV(ventas);
        });

        // Función para exportar los datos a un archivo CSV
        function exportarACSV(datos) {
            const encabezados = [
                "Nombre del Abonado",
                "Número de Abonado",
                "PERMISOR", 
                "Fecha de Venta",
                "Tipo de Servicio",
                "SERVICIOS", 
                "Estatus"
            ];

            const escapar = (valor) => {
                let str = String(valor || '');
                str = str.replace(/;/g, ','); 
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };

            let csvContent = encabezados.join(';') + '\n';

            datos.forEach((venta) => {
                const fila = [
                    escapar(venta.nombre),
                    escapar(venta.numero),
                    escapar(venta.permisorId), 
                    escapar(venta.fecha),
                    escapar(venta.tipoServicio),
                    escapar(venta.servicios),
                    escapar(venta.estatus)
                ];
                csvContent += fila.join(';') + '\n';
            });

            const blob = new Blob(["\ufeff", csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            const fechaHoy = new Date().toISOString().split('T')[0];
            link.setAttribute('download', `registro_ventas_inter_${fechaHoy}.csv`);
            
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('Exportación completada. Revisa tus descargas.', 'success');
        }

        // Configuración inicial al cargar el DOM
        document.addEventListener('DOMContentLoaded', setInitialDate);

        // Llamada inicial para asegurar que la tabla muestre el estado "vacío"
        actualizarTabla();

    </script>
</body>
</html>
